name: Build MSYS2 Terminal Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            base
            bash
            coreutils
            fish
            git
            mingw-w64-ucrt-x86_64-fzf
            mingw-w64-ucrt-x86_64-ripgrep
            mintty
            tmux

      - name: Verify packages installed
        shell: msys2 {0}
        run: |
          echo "=== Installed packages ==="
          pacman -Q tmux fish git mingw-w64-ucrt-x86_64-fzf mingw-w64-ucrt-x86_64-ripgrep mintty

          echo "=== Binary locations ==="
          which tmux fish git
          ls -la /ucrt64/bin/fzf.exe /ucrt64/bin/rg.exe

      - name: Get package versions
        id: versions
        shell: msys2 {0}
        run: |
          echo "tmux_version=$(pacman -Q tmux | awk '{print $2}')" >> $GITHUB_OUTPUT
          echo "fzf_version=$(pacman -Q mingw-w64-ucrt-x86_64-fzf | awk '{print $2}')" >> $GITHUB_OUTPUT
          echo "rg_version=$(pacman -Q mingw-w64-ucrt-x86_64-ripgrep | awk '{print $2}')" >> $GITHUB_OUTPUT
          echo "mintty_version=$(pacman -Q mintty | awk '{print $2}')" >> $GITHUB_OUTPUT
          echo "fish_version=$(pacman -Q fish | awk '{print $2}')" >> $GITHUB_OUTPUT
          echo "git_version=$(pacman -Q git | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Clean up MSYS2 environment
        shell: msys2 {0}
        run: |
          # Clear package cache to reduce size
          pacman -Scc --noconfirm

          # Remove cache files but keep directory structure
          rm -rf /var/cache/pacman/pkg/*
          rm -rf /var/log/*

          # Ensure required directories exist
          mkdir -p /tmp /dev/shm /dev/mqueue

          echo "Cleanup complete"

      - name: Get MSYS2 root path
        id: msys2path
        shell: pwsh
        run: |
          $msysRoot = (Get-Command msys2).Source | Split-Path | Split-Path
          echo "MSYS2_ROOT=$msysRoot" >> $env:GITHUB_OUTPUT
          Write-Host "MSYS2 root: $msysRoot"

      - name: Create archive
        shell: pwsh
        run: |
          $msysRoot = "${{ steps.msys2path.outputs.MSYS2_ROOT }}"
          $archiveName = "msys2-term.tar.gz"
          $tempArchive = "$env:RUNNER_TEMP\msys2-term.tar.gz"

          Write-Host "MSYS2 root: $msysRoot"
          Write-Host "Creating archive..."

          # Create archive using MSYS2's tar (output to runner temp, not inside msys2)
          & "$msysRoot\usr\bin\bash.exe" -lc "tar -C / --exclude='./proc' --exclude='./dev/fd' --exclude='./dev/std*' -czf '$($tempArchive -replace '\\','/')' ."

          # Move to workspace
          Move-Item $tempArchive -Destination "." -Force

          # Show archive size
          $size = (Get-Item $archiveName).Length / 1MB
          Write-Host "Archive size: $([math]::Round($size, 2)) MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: msys2-term
          path: msys2-term.tar.gz

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: msys2-term.tar.gz
          body: |
            ## MSYS2 Terminal Package

            Portable MSYS2 environment with **pacman support**.

            ### Pre-installed Tools
            | Tool | Version |
            |------|---------|
            | mintty | ${{ steps.versions.outputs.mintty_version }} |
            | fish | ${{ steps.versions.outputs.fish_version }} |
            | tmux | ${{ steps.versions.outputs.tmux_version }} |
            | git | ${{ steps.versions.outputs.git_version }} |
            | fzf | ${{ steps.versions.outputs.fzf_version }} |
            | ripgrep | ${{ steps.versions.outputs.rg_version }} |

            ### Quick Start
            1. Extract `msys2-term.tar.gz` to desired location (e.g., `C:\msys2`)
            2. Run `ucrt64.exe` or `msys2_shell.cmd -ucrt64` to open terminal
            3. Use `pacman -S <package>` to install additional packages

            Built with MSYS2 UCRT64 environment.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
