name: Build MSYS2 Terminal Package

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSYS2
        id: msys2
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          location: D:\
          update: true
          install: >-
            base
            coreutils
            curl
            fish
            mingw-w64-ucrt-x86_64-ansifilter
            mingw-w64-ucrt-x86_64-fzf
            mingw-w64-ucrt-x86_64-ripgrep
            mintty
            ncurses
            tmux

      - name: Verify packages installed
        shell: msys2 {0}
        run: |
          echo "=== Installed packages ==="
          pacman -Q tmux fish mingw-w64-ucrt-x86_64-ansifilter mingw-w64-ucrt-x86_64-fzf mingw-w64-ucrt-x86_64-ripgrep mintty

          echo "=== Binary locations ==="
          which tmux fish
          ls -la /ucrt64/bin/ansifilter.exe /ucrt64/bin/fzf.exe /ucrt64/bin/rg.exe

      - name: Fish syntax and lint check
        shell: msys2 {0}
        run: |
          echo "=== Fish syntax check ==="
          error_count=0
          for f in functions/*.fish completions/*.fish conf.d/*.fish; do
            if [ -f "$f" ]; then
              if fish --no-execute "$f" 2>&1; then
                echo "OK: $f"
              else
                echo "FAIL: $f"
                error_count=$((error_count + 1))
              fi
            fi
          done

          echo ""
          echo "=== Fish indent check (formatting) ==="
          for f in functions/*.fish completions/*.fish conf.d/*.fish; do
            if [ -f "$f" ]; then
              if diff -q "$f" <(fish_indent < "$f") > /dev/null 2>&1; then
                echo "OK: $f"
              else
                echo "WARN: $f (formatting differs from fish_indent)"
              fi
            fi
          done

          if [ $error_count -gt 0 ]; then
            echo ""
            echo "ERROR: $error_count file(s) failed syntax check"
            exit 1
          fi

          echo ""
          echo "All syntax checks passed"

      - name: Get package versions
        id: versions
        shell: msys2 {0}
        run: |
          echo "ansifilter_version=$(pacman -Q mingw-w64-ucrt-x86_64-ansifilter | awk '{print $2}')" >> $GITHUB_OUTPUT
          echo "fish_version=$(pacman -Q fish | awk '{print $2}')" >> $GITHUB_OUTPUT
          echo "fzf_version=$(pacman -Q mingw-w64-ucrt-x86_64-fzf | awk '{print $2}')" >> $GITHUB_OUTPUT
          echo "mintty_version=$(pacman -Q mintty | awk '{print $2}')" >> $GITHUB_OUTPUT
          echo "rg_version=$(pacman -Q mingw-w64-ucrt-x86_64-ripgrep | awk '{print $2}')" >> $GITHUB_OUTPUT
          echo "tmux_version=$(pacman -Q tmux | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Copy skeleton files
        shell: msys2 {0}
        run: |
          echo "=== Copying skeleton files ==="
          cp -rv skel/. /etc/skel/
          echo "=== Skeleton files installed ==="
          find /etc/skel -type f

      - name: Install Fisher and plugins
        shell: msys2 {0}
        run: |
          # Create temporary home for Fisher installation
          export HOME=/tmp/fisher-setup
          mkdir -p $HOME/.config/fish

          # Copy fish config from skel
          cp -r /etc/skel/.config/fish/. $HOME/.config/fish/

          # Install Fisher and plugins using fish
          echo "=== Installing Fisher and plugins ==="
          fish -c '
            # Install Fisher
            curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source
            fisher install jorgebucaran/fisher

            # Install plugins from fish_plugins
            if test -f ~/.config/fish/fish_plugins
              echo "Installing plugins from fish_plugins:"
              cat ~/.config/fish/fish_plugins
              fisher update
            end
          '

          # Copy installed plugins back to skel
          echo "=== Copying plugins to skel ==="
          cp -rv $HOME/.config/fish/completions /etc/skel/.config/fish/ 2>/dev/null || true
          cp -rv $HOME/.config/fish/conf.d /etc/skel/.config/fish/ 2>/dev/null || true
          cp -rv $HOME/.config/fish/functions /etc/skel/.config/fish/

          echo "=== Fisher installation complete ==="
          find /etc/skel/.config/fish -type f

      - name: Clean up MSYS2 environment
        shell: msys2 {0}
        run: |
          # Clear package cache to reduce size
          pacman -Scc --noconfirm

          # Remove cache files but keep directory structure
          rm -rf /var/cache/pacman/pkg/*
          rm -rf /var/log/*

          # Ensure required directories exist with placeholder files
          mkdir -p /tmp /dev/shm /dev/mqueue
          touch /tmp/.keep /dev/shm/.keep /dev/mqueue/.keep

          # Verify critical directories
          echo "=== Checking critical directories ==="
          ls -la /etc/skel/ || echo "WARNING: /etc/skel missing!"
          ls -la /tmp/
          ls -la /dev/

          echo "Cleanup complete"

      - name: Create zip archive
        id: archive
        shell: pwsh
        run: |
          $msysRoot = "${{ steps.msys2.outputs.msys2-location }}"
          $shortSha = "${{ github.sha }}".Substring(0, 7)
          $zipName = "msys2-term-$shortSha.zip"

          # Remove items that shouldn't be in the archive
          Remove-Item -Path "$msysRoot\proc" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$msysRoot\dev\fd" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$msysRoot\dev\std*" -Force -ErrorAction SilentlyContinue

          # Create zip with 7-Zip
          7z a -tzip -mx=5 $zipName "$msysRoot\*"

          $size = (Get-Item $zipName).Length / 1MB
          Write-Host "Archive: $zipName ($([math]::Round($size, 2)) MB)"

          echo "zip_name=$zipName" >> $env:GITHUB_OUTPUT
          echo "short_sha=$shortSha" >> $env:GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: msys2-term-${{ steps.archive.outputs.short_sha }}
          path: ${{ steps.archive.outputs.zip_name }}

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.archive.outputs.zip_name }}
          body: |
            ## MSYS2 Terminal Package

            Portable MSYS2 environment with **pacman support**.

            ### Pre-installed Tools

            | Tool       | Version                                          |
            |------------|--------------------------------------------------|
            | mintty     | ${{ steps.versions.outputs.mintty_version }}     |
            | fish       | ${{ steps.versions.outputs.fish_version }}       |
            |            |                                                  |
            | ansifilter | ${{ steps.versions.outputs.ansifilter_version }} |
            | fzf        | ${{ steps.versions.outputs.fzf_version }}        |
            | ripgrep    | ${{ steps.versions.outputs.rg_version }}         |
            | tmux       | ${{ steps.versions.outputs.tmux_version }}       |

            ### Quick Start

            1. Extract `msys2-term.zip` to desired location (e.g., `C:\msys2`)
            2. Run `ucrt64.exe` or `msys2_shell.cmd -ucrt64` to open terminal
            3. Use `pacman -S <package>` to install additional packages

            Built with MSYS2 UCRT64 environment.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
